<?xml version="1.0" encoding="UTF-8"?>
<con:soapui-project id="5c4b50dd-7d10-4b90-88ff-bade2f5bee1c" activeEnvironment="Default" name="REST Project 1" resourceRoot="" soapui-version="5.2.1" abortOnError="false" runType="SEQUENTIAL" xmlns:con="http://eviware.com/soapui/config"><con:settings/><con:interface xsi:type="con:RestService" id="16c17dc7-0a94-465f-8773-3e4b99b1765c" wadlVersion="http://wadl.dev.java.net/2009/02" name="http://gc.ditu.aliyun.com" type="rest" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings/><con:definitionCache type="TEXT" rootPart=""/><con:endpoints><con:endpoint>http://gc.ditu.aliyun.com</con:endpoint></con:endpoints><con:resource name="Geocoding" path="/geocoding" id="f9e3ec91-9898-4d40-b5ab-13487713589a"><con:settings/><con:parameters><con:parameter><con:name>a</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter></con:parameters><con:method name="Geocoding" id="671b95c5-a013-423e-8350-80d8e21e23d6" method="GET"><con:settings/><con:parameters/><con:request name="Request 1" id="ebb69417-3a78-453d-ba0f-f1f07379d16f" mediaType="application/json"><con:settings/><con:endpoint>http://gc.ditu.aliyun.com</con:endpoint><con:request/><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:parameterOrder><con:entry>a</con:entry></con:parameterOrder></con:request></con:method></con:resource></con:interface><con:testSuite id="20d89adf-e203-4ab0-92f1-0ed36b8afabc" name="common_testsuite"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="37a41d9c-f4b2-4261-8ac6-41738931ecd3" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="cookie" searchProperties="true"><con:settings/><con:testStep type="properties" name="user_cookie" id="190a2064-edc9-4c63-bf57-a4f99048a04f"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>user001</con:name><con:value>DedeUserID=15663561;DedeUserID__ckMd5=215d9245b74d109f;SESSDATA=f7ae1726%2C1447838173%2C75dfa3b4;_dfcaptcha=a5f6f6425d29132b63dfad61bd91f584;sid=d4lo0f8a	;</con:value></con:property><con:property><con:name>user002</con:name><con:value>DedeUserID=18456254;DedeUserID__ckMd5=3b9b211782a95697;SESSDATA=d2c7ce9b%2C1447917546%2Cf23702f6;</con:value></con:property><con:property><con:name>user_super001</con:name><con:value>DedeUserID=5746800; DedeUserID__ckMd5=7ee132bc92fc7305; SESSDATA=c0dcae73%2C1445863602%2C60b6d178;</con:value></con:property><con:property><con:name>teardown</con:name><con:value/></con:property><con:property><con:name>user005</con:name><con:value>DedeUserID=17191256; DedeUserID__ckMd5=3584ad65e4e5417e; SESSDATA=dfee6279%2C1447842876%2C0c5974c6;_dfcaptcha=08de96f86edbed0f600fe5d20536ec84;sid=le4i1bqk;</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="properties" name="access_key" id="857c8442-2a57-4e15-ac3b-67c01887fb3e"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>access001</con:name><con:value>access_key=cc98358c7cf3a8da570f0bc26ed325ff</con:value></con:property></con:properties></con:config></con:testStep><con:properties/><con:reportParameters/></con:testCase><con:testCase id="a02a8ab5-762b-4d0e-a2f9-82aa55a0de48" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="map" searchProperties="true"><con:settings/><con:testStep type="properties" name="testdata" id="48ce469f-fcdd-4cab-a6f7-1da76a38bf93"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>a</con:name><con:value/></con:property></con:properties></con:config></con:testStep><con:testStep type="transfer" name="Property Transfer" id="0157fa15-190d-4963-b9a1-ab5947605e80"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>a</con:name><con:sourceType>a</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>a</con:targetType><con:targetStep>map</con:targetStep><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="restrequest" name="map" id="5789022a-f139-4a91-a312-7f7e2bb77286"><con:settings/><con:config service="http://gc.ditu.aliyun.com" resourcePath="/geocoding" methodName="Geocoding" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="map" id="ebb69417-3a78-453d-ba0f-f1f07379d16f" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="Cookie" value="" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>http://gc.ditu.aliyun.com</con:endpoint><con:request/><con:originalUri>http://gc.ditu.aliyun.com/geocoding</con:originalUri><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><entry key="a" value="苏州市" xmlns="http://eviware.com/soapui/config"/></con:parameters><con:parameterOrder><con:entry>a</con:entry></con:parameterOrder></con:restRequest></con:config></con:testStep><con:properties/></con:testCase><con:properties/></con:testSuite><con:testSuite id="5a744a35-16ce-4c8b-bac8-9e955c364286" name="TestSuite 2"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="c3e2d9cf-c7bd-4246-9dc8-e4e77eb7c12b" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="TestCase 1" searchProperties="true"><con:settings/><con:testStep type="groovy" name="Groovy Script" id="7b1bbfac-45d1-4959-8604-8a2f346eb691"><con:settings/><con:config><script>import com.eviware.soapui.support.types.StringToObjectMap
import groovy.json.JsonSlurper
import com.eviware.soapui.impl.wsdl.support.http.HttpClientSupport
import org.apache.http.impl.cookie.BasicClientCookie
import com.eviware.soapui.support.types.StringToStringMap


def params_list = ['a=苏州市']
log.info("join")
log.info '===================================='

def testcase_name = 'map'
def teststep_name = 'map'

def re = getContentOut(testcase_name,teststep_name,params_list)

assert(re.level == 2)
log.info re
log.info '++++++++++++++++++++++++++++++++++++'

def getContentOut(String testcase_name,String teststep_name,List request_params){
	def testproject = testRunner.testCase.testSuite.project
	def testcase = testproject.testSuites['common_testsuite'].testCases[testcase_name]

	for(i in request_params){
		testcase.testSteps['testdata'].setPropertyValue(i.split('=')[0],i.split('=')[1])
		}

	def contextMap = new StringToObjectMap(context)
	def runner = testcase.run(contextMap,false)
	//获取测试的请求
	def testcase_stepcount = testcase.getTestStepCount() 

	def response_content = runner.getResults()[testcase_stepcount-1].getResponseContent()
     //还原设置参数
	tearDownInput(testcase_name,request_params)
    
	//还原cookie设置
	setCookies(testcase_name, teststep_name,'teardown')

     //把测试结果json化后传出去
	def slurper = new JsonSlurper()
	def re = slurper.parseText(response_content)
	
	return re
}


def tearDownInput(String testcase_name,List request_params){
	for(i in request_params){
		testRunner.testCase.testSuite.project.testSuites['common_testsuite'].testCases[testcase_name].testSteps['testdata'].setPropertyValue(i.split('=')[0],'')
		}
}


def setCookies(String testcase_name,String teststep_name,String userid){
	//按用户名读取预置的cookie值
	def testproject = testRunner.testCase.testSuite.project
	def cookies_str = testproject.testSuites['common_testsuite'].testCases['cookie'].testSteps['user_cookie'].getPropertyValue(userid)
	def reqheaders = new StringToStringMap()
	reqheaders.put('Cookie',cookies_str)
	testproject.testSuites['common_testsuite'].getTestCaseByName(testcase_name).getTestStepByName(teststep_name).testRequest.setRequestHeaders(reqheaders)	
}


def setaptcha(String userid,List prams_list){
	//按用户名读取预置的cookie值
	def testproject = testRunner.testCase.testSuite.project
	def cookies_str = testproject.testSuites['common_testsuite'].testCases['cookie'].testSteps['user_cookie'].getPropertyValue(userid)
	
	def values = cookies_str.split(';')
	
	for(i in (0..(values.size()-1))){
		if(values[i].split('=')[0] == '_dfcaptcha') {
			prams_list.add('captcha=' + values[i].split('=')[1])
			return prams_list
		}
	}
}
</script></con:config></con:testStep><con:properties/></con:testCase><con:properties/></con:testSuite><con:properties/><con:wssContainer/><con:oAuth2ProfileContainer/></con:soapui-project>