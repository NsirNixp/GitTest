<?xml version="1.0" encoding="UTF-8"?>
<con:soapui-project id="efaaa97e-59a5-4e93-8d6e-4d91645755f1" activeEnvironment="Default" name="favorite_service_easy" resourceRoot="" soapui-version="5.1.2" xmlns:con="http://eviware.com/soapui/config"><con:settings/><con:interface xsi:type="con:RestService" id="9b2426b0-0916-4869-9fbd-dcd011e8d7f5" wadlVersion="http://wadl.dev.java.net/2009/02" name="http://api.bilibili.com" type="rest" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:settings/><con:definitionCache type="TEXT" rootPart=""/><con:endpoints><con:endpoint>http://api.bilibili.com</con:endpoint></con:endpoints><con:resource name="" path="/x/v2/fav/folder" id="6606c1ed-58cd-46d8-b570-53b4318eea38"><con:settings/><con:parameters><con:parameter><con:name>appkey</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter><con:parameter><con:name>sign</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter><con:parameter><con:name>mid</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter><con:parameter><con:name>ts</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter><con:parameter><con:name>jsonp</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter><con:parameter><con:name>vmid</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter><con:parameter><con:name>callback</con:name><con:value/><con:style>QUERY</con:style><con:default/><con:description xsi:nil="true"/></con:parameter></con:parameters><con:method name="" id="4d52fa1f-4661-4381-ae7f-3251b115e42e" method="GET"><con:settings/><con:parameters/><con:representation type="RESPONSE"><con:mediaType>application/json;charset=utf-8</con:mediaType><con:status>200</con:status><con:params/><con:element xmlns:fol="http://api.bilibili.com/x/v2/favourite/folder">fol:Response</con:element></con:representation><con:representation type="FAULT"><con:mediaType>text/html; charset=utf-8</con:mediaType><con:status>404</con:status><con:params/><con:element>html</con:element></con:representation><con:representation type="FAULT"><con:mediaType>text/html</con:mediaType><con:status>404</con:status><con:params/><con:element>html</con:element></con:representation><con:request name="获取用户收藏夹" id="09713235-4800-442a-ab74-0dafabc71f1a" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://api.bilibili.com</con:endpoint><con:request/><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/><con:parameterOrder><con:entry>appkey</con:entry><con:entry>sign</con:entry><con:entry>mid</con:entry><con:entry>ts</con:entry><con:entry>jsonp</con:entry><con:entry>vmid</con:entry><con:entry>callback</con:entry></con:parameterOrder></con:request></con:method></con:resource></con:interface><con:testSuite id="40673c90-c41e-4b33-98ee-4789020bf7e3" name="common_testsuite"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="a7a514ec-6721-467f-bf1e-2796cc8addb1" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="cookie" searchProperties="true"><con:settings/><con:testStep type="properties" name="user_cookie" id="20835619-6672-4c8b-b19c-7a26e8d4f9b8"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>user001</con:name><con:value>DedeUserID=15663561;DedeUserID__ckMd5=215d9245b74d109f;SESSDATA=f7ae1726%2C1447228006%2C2ae7d08c;_dfcaptcha=f7d457380fc124c54c63b213da5274ef;sid=le4i1bqk;</con:value></con:property><con:property><con:name>user002</con:name><con:value/></con:property><con:property><con:name>user_super001</con:name><con:value>DedeUserID=5746800; DedeUserID__ckMd5=7ee132bc92fc7305; SESSDATA=c0dcae73%2C1445863602%2C60b6d178;</con:value></con:property><con:property><con:name>teardown</con:name><con:value/></con:property><con:property><con:name>user005</con:name><con:value>DedeUserID=17191256; DedeUserID__ckMd5=3584ad65e4e5417e; SESSDATA=dfee6279%2C1447147750%2Cadbe8899;_dfcaptcha=8d62da0cb8dce674cd0717e0489a184d;sid=an0mgthy;</con:value></con:property><con:property><con:name>user000</con:name><con:value>DedeUserID=4780461; DedeUserID__ckMd5=13d78097a9671f45; SESSDATA=bc1f02ec%2C1460440119%2C01a0da55;_dfcaptcha=fd193bf522249100552f1f3f17ae172a;sid=7zm9i1qf;</con:value></con:property><con:property><con:name>usernixp</con:name><con:value>DedeUserID=17668003;DedeUserID__ckMd5=b3fef45a8bc1a762;SESSDATA=574b1bcf%2C1475123452%2C7ca812cc;_dfcaptcha=84b3ded09e574ccc6e4c6c0b50b60a13;sid=aroj0p2g;</con:value></con:property></con:properties></con:config></con:testStep><con:testStep type="properties" name="access_key" id="bd539e02-c509-4d27-8d81-3c6e6de396fe"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>access000</con:name><con:value>access_key=d3ac48906b9ffafa4524a9cdee9e7455</con:value></con:property></con:properties></con:config></con:testStep><con:properties/><con:reportParameters/></con:testCase><con:testCase id="0a6bc013-e8b8-4824-acd0-40da81fa208c" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="/x/v2/favourite/folder" searchProperties="true"><con:settings/><con:testStep type="groovy" name="tssign" id="963d62b7-fea3-4174-b208-58400bf8edfa"><con:settings/><con:config><script>import java.util.*
import java.security.MessageDigest
import java.net.URLEncoder

//计算时间戳
Date date = new Date()
def st_string = date.getTime()
st_string = st_string.toString()
st_string = st_string.substring(0,10)


//===========================需要手工参与的地方=======================================
//1.设置data_list
//设置预读取的testdata里除sign以外的参数名字，用于计算md5
def data_list = ['appkey','mid','ts','jsonp','callback','vmid']
//测试专用的appkey
def appkey_str = '7d9f6f6fe2a898e8'
//测试专用appkey对应的appsecret
def appsecret_str = '4de2ccdbd9db69be0c2c6437bfe6eb69'
//====================================================================================

//修改list按字母排序
data_list = data_list.sort()
log.info data_list

testRunner.testCase.testSteps["testdata"].setPropertyValue('ts',st_string)
testRunner.testCase.testSteps["testdata"].setPropertyValue('appkey',appkey_str)
testRunner.testCase.testSteps["testdata"].setPropertyValue('jsonp','jsonp')
def n = 0
def sg_orgin_string = ''
def sg_md5_string = ''

while (n&lt;data_list.size()){
	def getLocalPropValue = ''
	if(data_list[n] == 'appkey'){
		sg_orgin_string = sg_orgin_string + data_list[n] + '=' + java.net.URLEncoder.encode(appkey_str,'UTF-8') + '&amp;' 
	}else{
		if( testRunner.testCase.testSteps["testdata"].getPropertyValue(data_list[n]) == ''){
			log.info('null')
		}else{
			getLocalPropValue = testRunner.testCase.testSteps["testdata"].getPropertyValue(data_list[n])
			sg_orgin_string = sg_orgin_string + data_list[n] + '=' + java.net.URLEncoder.encode(getLocalPropValue,'UTF-8') + '&amp;'
		}
	}
	n = n + 1
}

def orgin_len = sg_orgin_string.size()
sg_orgin_string = sg_orgin_string[0..(orgin_len-2)]

//还原空格设置
sg_orgin_string = sg_orgin_string.replace('^',' ')

sg_orgin_string =  sg_orgin_string + appsecret_str
sg_md5_string = getMD5(sg_orgin_string)

log.info sg_orgin_string
log.info sg_md5_string

testRunner.testCase.testSteps["testdata"].setPropertyValue('sign',sg_md5_string)


//get md5
//=============================
def getMD5(String source){
	MessageDigest md5 = MessageDigest.getInstance("MD5")
	md5.update(source.getBytes())
	byte[] digest = md5.digest()
	StringBuffer sb = new StringBuffer()
	digest.eachByte {
		 sb.append(String.format("%02x", it &amp; 0xff)) 
	}
	return sb.toString()
}
</script></con:config></con:testStep><con:testStep type="properties" name="testdata" id="1eb5ac5d-a0a0-4425-94be-3e2f761b6a69"><con:settings/><con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:properties><con:property><con:name>appkey</con:name><con:value>7d9f6f6fe2a898e8</con:value></con:property><con:property><con:name>mid</con:name><con:value/></con:property><con:property><con:name>sign</con:name><con:value>cd22a2a44f03725735898b97b8cc4060</con:value></con:property><con:property><con:name>ts</con:name><con:value>1472613318</con:value></con:property><con:property><con:name>jsonp</con:name><con:value>jsonp</con:value></con:property><con:property><con:name>callback</con:name><con:value/></con:property><con:property><con:name>vmid</con:name><con:value/></con:property></con:properties></con:config></con:testStep><con:testStep type="transfer" name="Property Transfer" id="5dd1be3b-3b9d-4651-8539-2769210f5a38"><con:settings/><con:config xsi:type="con:PropertyTransfersStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>appkey</con:name><con:sourceType>appkey</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>appkey</con:targetType><con:targetStep>/x/v2/favourite/folder</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>sign</con:name><con:sourceType>sign</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>sign</con:targetType><con:targetStep>/x/v2/favourite/folder</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>ts</con:name><con:sourceType>ts</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>ts</con:targetType><con:targetStep>/x/v2/favourite/folder</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>mid</con:name><con:sourceType>mid</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>mid</con:targetType><con:targetStep>/x/v2/favourite/folder</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>jsonp</con:name><con:sourceType>jsonp</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>jsonp</con:targetType><con:targetStep>/x/v2/favourite/folder</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>callback</con:name><con:sourceType>callback</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>callback</con:targetType><con:targetStep>/x/v2/favourite/folder</con:targetStep><con:upgraded>true</con:upgraded></con:transfers><con:transfers setNullOnMissingSource="true" transferTextContent="true" failOnError="true" ignoreEmpty="false" transferToAll="false" entitize="false" transferChildNodes="false"><con:name>vmid</con:name><con:sourceType>vmid</con:sourceType><con:sourceStep>testdata</con:sourceStep><con:targetType>vmid</con:targetType><con:targetStep>/x/v2/favourite/folder</con:targetStep><con:upgraded>true</con:upgraded></con:transfers></con:config></con:testStep><con:testStep type="restrequest" name="/x/v2/favourite/folder" id="4fc2f18c-7dd1-44c6-9521-6a2ae7963061"><con:settings/><con:config service="http://api.bilibili.com" resourcePath="/x/v2/fav/folder" methodName="" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="/x/v2/favourite/folder" id="09713235-4800-442a-ab74-0dafabc71f1a" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;entry key="Cookie" value="" xmlns="http://eviware.com/soapui/config"/></con:setting></con:settings><con:endpoint>http://api.bilibili.com</con:endpoint><con:request/><con:originalUri>http://api.bilibili.com/x/v2/favourite/folder</con:originalUri><con:credentials><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters>
  <con:entry key="sign" value="cd22a2a44f03725735898b97b8cc4060"/>
  <con:entry key="ts" value="1472613318"/>
  <con:entry key="jsonp" value="jsonp"/>
  <con:entry key="appkey" value="7d9f6f6fe2a898e8"/>
  <con:entry key="mid" value="17668003"/>
</con:parameters><con:parameterOrder><con:entry>appkey</con:entry><con:entry>sign</con:entry><con:entry>mid</con:entry><con:entry>ts</con:entry><con:entry>jsonp</con:entry><con:entry>vmid</con:entry><con:entry>callback</con:entry></con:parameterOrder></con:restRequest></con:config></con:testStep><con:properties/><con:reportParameters/><con:breakPoints><con:testStepId>1915cda0-6e39-450e-93ad-520140626577</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>80334f19-860a-4fb9-a09c-ff05e01a7ba5</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>0ba56c8e-1001-41a6-9ca6-975dbdbc0152</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ce864572-412e-49ad-b57a-f79df9b78b7a</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase><con:properties/><con:reportParameters/></con:testSuite><con:testSuite id="3f7cf7b8-6a8b-4932-afdd-ce8a8f6ac6ed" name="case"><con:settings/><con:runType>SEQUENTIAL</con:runType><con:testCase id="03084889-ae6a-4462-bf82-c1d33965afcb" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="change_url" searchProperties="true"><con:settings/><con:testStep type="groovy" name="Groovy Script" id="246048e5-8360-47bc-9ca2-153a31b12b54"><con:settings/><con:config><script>proFile = "/User/Hugo/nixp/test.properties"
props = new java.util.Properties()
FileInputStream fs
try {
	fs = new FileInputStream(proFile)
	props.load(fs)
}catch (FileNotFoundException e){
	log.info e
}finally {
	if (fs != null) {
		fs.close()
	}else{return}}
//从当前的testsuite找到当前项目，通过项目列出所有的testsuites列表
testRunner.testCase.testSuite.project.getTestSuiteList().each {testsuite ->
//	遍历所有的testsuites，找到名字为common_testsuite的套件
	if (testsuite.getName() == 'common_testsuite') {
//		读取配置文件中key
		Iterator iter = props.keys().iterator()
		while(iter.hasNext()){
			key = iter.next()
//			获取当前testsuite的testcase列表
//			testsuite.getTestCaseList().each{testcase->
			for (testcase in testsuite.getTestCaseList()){
//			获取testcase的teststeps列表
//				testcase.getTestStepList().each {teststep ->
				for ( teststep in testcase.getTestStepList()){
//				在列表中找到类型为restrequest的组件，同时满足key值为account，然后设置组件的endpoint属性值为props[key]
					if (teststep.getConfig().type == 'restrequest' &amp;&amp; key == 'history') {
							teststep.setPropertyValue('Endpoint', props[key])
							log.info props[key]
					}
				}
			}
    		}
	}
}</script></con:config></con:testStep><con:properties/><con:reportParameters/></con:testCase><con:testCase id="d0af5055-0cca-4438-a5b5-d350cc050610" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="TestCase 1" searchProperties="true"><con:settings/><con:testStep type="groovy" name="获取用户的收藏夹" id="bf4035bf-9cd2-4b7e-9369-1f37ed5883ec"><con:settings/><con:config><script>import com.eviware.soapui.support.types.StringToObjectMap
import groovy.json.JsonSlurper
import com.eviware.soapui.impl.wsdl.support.http.HttpClientSupport
import org.apache.http.impl.cookie.BasicClientCookie
import com.eviware.soapui.support.types.StringToStringMap
//配置参数
def params_list =  ['mid=17668003']

log.info("获取用户的收藏夹")

log.info(params_list)
//选择执行的测试套件

setCookies('/x/v2/favourite/folder', '/x/v2/favourite/folder', 'usernixp')
def testcase_name = '/x/v2/favourite/folder'
def teststep_name = '/x/v2/favourite/folder'

def re = getContentOut(testcase_name,teststep_name,params_list)

//检验返回码
assert(re.code == 0)
log.info(re)

def getContentOut(String testcase_name,String teststep_name,List request_params){
	def testproject = testRunner.testCase.testSuite.project
	def testcase = testproject.testSuites['common_testsuite'].testCases[testcase_name]

	for(i in request_params){
		testcase.testSteps['testdata'].setPropertyValue(i.split('=')[0],i.split('=')[1])
		log.info i.split('=')[0]
		log.info i.split('=')[1]
		}

	def contextMap = new StringToObjectMap(context)
	def runner = testcase.run(contextMap,false)
	//获取测试的请求
	def testcase_stepcount = testcase.getTestStepCount() 

	def response_content = runner.getResults()[testcase_stepcount-1].getResponseContent()
	log.info response_content
     //还原设置参数
	tearDownInput(testcase_name,request_params)

	//还原cookie设置
	setCookies(testcase_name, teststep_name,'teardown')

     //把测试结果json化后传出去
	def slurper = new JsonSlurper()
	def re = slurper.parseText(response_content)
	
	return re
}


def tearDownInput(String testcase_name,List request_params){
	for(i in request_params){
		testRunner.testCase.testSuite.project.testSuites['common_testsuite'].testCases[testcase_name].testSteps['testdata'].setPropertyValue(i.split('=')[0],'')
		}
}


def setCookies(String testcase_name,String teststep_name,String userid){
	//按用户名读取预置的cookie值
	def testproject = testRunner.testCase.testSuite.project
	def cookies_str = testproject.testSuites['common_testsuite'].testCases['cookie'].testSteps['user_cookie'].getPropertyValue(userid)
	def reqheaders = new StringToStringMap()
	reqheaders.put('Cookie',cookies_str)
	testproject.testSuites['common_testsuite'].getTestCaseByName(testcase_name).getTestStepByName(teststep_name).testRequest.setRequestHeaders(reqheaders)	
}


def setaptcha(String userid,List prams_list){
	//按用户名读取预置的cookie值
	def testproject = testRunner.testCase.testSuite.project
	def cookies_str = testproject.testSuites['common_testsuite'].testCases['cookie'].testSteps['user_cookie'].getPropertyValue(userid)
	
	def values = cookies_str.split(';')
	
	for(i in (0..(values.size()-1))){
		if(values[i].split('=')[0] == '_dfcaptcha') {
			prams_list.add('captcha=' + values[i].split('=')[1])
			return prams_list
		}
	}
	
}
</script></con:config></con:testStep><con:properties/><con:reportParameters/></con:testCase><con:properties/><con:reportParameters/></con:testSuite><con:requirements/><con:properties/><con:wssContainer/><con:databaseConnectionContainer/><con:oAuth2ProfileContainer/><con:reporting><con:reportTemplates/><con:xmlTemplates/><con:parameters/></con:reporting><con:sensitiveInformation/></con:soapui-project>